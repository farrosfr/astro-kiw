---
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import HomepageBanner from '../components/HomepageBanner.astro'; // Impor banner baru
import { pool } from '../lib/db';
import type { Product } from '../data/products';

// Fetch products for the preview section
let previewProducts: Product[] = [];
let error: string | null = null;

try {
  const [rows] = await pool.query('SELECT id, name, price, imageUrl, description, slug FROM products ORDER BY created_at DESC LIMIT 4');
  previewProducts = (rows as any[]).map(row => ({
    ...row,
    id: String(row.id),
  }));
} catch (e: any) {
  console.error(e);
  // Don't block the whole page if the preview fails to load
  error = "Gagal memuat pratinjau produk."; 
}
---

<Layout title="Beranda">
  
  <!-- New Banner Section -->
  <HomepageBanner />

  <!-- Product Preview Section -->
  {previewProducts.length > 0 && (
    <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <h2 class="text-3xl font-extrabold text-gray-900">Pratinjau Katalog Produk</h2>
          <p class="mt-4 text-lg text-gray-600">Lihat beberapa produk unggulan yang tersedia di platform kami.</p>
        </div>
        <div class="mt-12 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          {previewProducts.map(product => (
            <ProductCard product={product} />
          ))}
        </div>
        <div class="mt-12 text-center">
          <a href="/katalog" class="inline-block px-6 py-3 border border-transparent text-base font-medium rounded-md text-blue-600 bg-blue-100 hover:bg-blue-200">
            Lihat Semua Produk &rarr;
          </a>
        </div>
      </div>
    </section>
  )}

  {error && (
      <div class="text-center py-10">
        <p class="text-red-500">{error}</p>
      </div>
  )}

</Layout>